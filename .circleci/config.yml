version: 2.1

jobs:
  test:
    machine:
      # Note that ubuntu with versions later than 2022 triggers an interative prompt that gets CI stuck
      image: ubuntu-2004:202107-02
    environment:
      PYTHON_VERSION: "3.8"
    steps:
      - checkout

      - run:
          name: Additional info about the build
          command: |
            uname -a
            df -h
            ulimit -a

      - run:
          name: Set up Miniconda
          command: |
            sudo apt-get update
            sudo apt install build-essential
            mkdir -p ~/miniconda3
            wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda3/miniconda.sh
            bash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3
            rm -rf ~/miniconda3/miniconda.sh
            ~/miniconda3/bin/conda init bash
            ~/miniconda3/bin/conda init zsh
            conda --version
            python --version
            which pip

      - run:
          name: Install required dependencies for GROMACS
          command: |
            sudo apt-get install ccache libblas-dev libfftw3-dev liblapack-dev libmpich-dev libxml2-dev mpich ninja-build
            wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | sudo tee /etc/apt/trusted.gpg.d/kitware.gpg >/dev/null
            sudo apt-add-repository 'deb https://apt.kitware.com/ubuntu/ focal main' -y
            sudo apt install cmake && cmake --version

      - run:
          name: Install the latest GROMACS 
          command: |
            gcc --version
            g++ --version 
            export CC=`which gcc`
            export CXX=`which g++`

            ccache -s
            cd $HOME && mkdir pkgs 
            git clone https://gitlab.com/gromacs/gromacs.git
            cd gromacs && mkdir build && cd build
            cmake .. -DCMAKE_CXX_COMPILER=$CXX -DCMAKE_C_COMPILER=$CC -DCMAKE_INSTALL_PREFIX=$HOME/pkgs -DGMX_ENABLE_CCACHE=ON
            make install 
            source $HOME/pkgs/bin/GMXRC
            gmx --version
            ccache -s

      - run:
          name: Install the latest GROMACS and gmxpi
          command: |
            source $HOME/pkgs/bin/GMXRC
            python -m ensurepip --default-pip
            pip install --upgrade pip wheel
            pip install "pybind11>=2.6" "setuptools>=42.0"
            python -m pip install --upgrade pip setuptools
            pip install --upgrade mpi4py
            pip install gmxapi==0.4.0rc2
            python -c "import gmxapi; print(gmxapi.__version__)"

      - run:
          name: Install ensemble_md dependencies
          command: |
            python -m pip install . --no-deps
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
            conda list

      - run:
          name: Run tests
          command: |
            pip install pytest 
            pip install pytest-cov
            pytest -vv --disable-pytest-warnings --cov=ensemble_md --cov-report=xml --color=yes ensemble_md/tests/

      - run:
          name: CodeCov
          command: |
            bash <(curl -s https://codecov.io/bash)

workflows:
  continuous-integration-workflow:
    jobs:
      - test
